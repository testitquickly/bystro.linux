Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2025-06-13T19:23:26+03:00

====== Выход видеосигнала через iGPU ======

[ @video @hdmi ]

На материнской плате установлена дискретная видеокарта (GPU). При установке системы она была определена как основной источник видеосигнала, который идет в монитор по кабелю Display Port. 

Неочевидно, что если подключить монитор к материнской плате по HDMI,  видео в монитор всё равно идёт через дискретную видеокарту, даже если она уже не подключена к монитору через DP. Внешне это выглядит так, словно истема «застревает» на этапе загрузки ''sddm.service''.

Надо сделать так, чтобы видео шло через CPU и выход HDMI на материнской плате (iGPU), в обход дискретной видеокарты.

Сперва надо убедиться в том, что у процессора есть «встроенное видео». В моём случае был AMD из семейства Ryzen, у которого на борту есть  AMD Radeon Graphics, 2 графических ядра (CU). Это базовый видеовывод, недостаточный для игр, но исчерпывающе достаточный для кино (1080p/2160p, 4K@60 Гц) и прочего стандартного.

===== Настроить вывод графики в BIOS =====

В компьютере установлена материнская плата Gigabyte «B650M» — игровая модель с большим количеством разъемов для подключений, в том числе и HDMI. Вход в её BIOS через [Del].

''Settings''
''> IO Ports''
''> Initial display output:''
* IGD Video (встроенное GPU процессора)
* PCIe 1 Slot (дискретная видеокарта)

Переключил на “IGD Video”.

Настроить управление встроенным видеоядром в процессоре. 

'''
Settings
> Integrated Graphics:
'''
* авто
* Forces
* запрещено

Переключил на “Forces”.

[F10].

===== Загрузить систему в консольном режиме =====

На экране GRUB2 (где выбираешь вход в операционную систему) потыркать клавишами вниз-вверх, чтобы остаться на данном экране.

Установить курсор на пункт загрузки (Debian, в моем случае), нажать клавишу “e” — откроется редактор параметров загрузки ядра.

Найти строку, которая начинается с ”''linux /boot/vmlinuz-...''”:

* //если// там есть параметр ''nomodeset'' — убрать его. Он запрещает ядру загружать графические модули и имеет смысл только когда надо всё видео гонять через дискретную видеокарту.
* в конце этой строки добавить пробел и команду 

''systemd.unit=multi-user.target''

Ctrl+X для сохранения и выхода, и загружаемся в терминал (без GUI).

Залогиниться под действующим юзером с правом sudo.

===== Установить драйвер amdgpu =====

''sudo apt update; sudo apt install firmware-amd-graphics xserver-xorg-video-amdgpu''

Проверить, какие источники видеосигнала распознает Debian:

''lspci grep vga'' 

Пример ответа:
* ''nvidia geforce rtx 4070 super'' 
* ''advanced micro devices amd/ati raphael''

Ок, видим два источника — дискретную видеокарту и внутренний GPU процессора (семейство Raphael, что бы эти ни значило).

Загрузить драйвер «внутренней видеокарты»:

''sudo modprobe amdgpu''

Проверить, загружен ли драйвер в память:

''lsmod | grep amdgpu''

Если в ответ будет тишина — что-то пошло не так.

Еще можно проверить дела через 

''dmesg | grep -i firmware''

Должен появиться список существующих прошивок. Если их нет, то будет что-то вроде:

''amdgpu 0000:05:00.0: firmware: failed to load ...''

Отдельная проверка на наличие пакетов:

'''
dpkg -l | grep firmware-amd-graphics
'''

Ожидаем ответ вроде:

''ii  firmware-amd-graphics ...''

иначе алярм.

Перезагружаемся

''sudo reboot''

На экране GRUB2 снова потыркать клавишами вниз-вверх, чтобы остаться на данном экране, установить курсор на пункт загрузки (Debian, в моем случае), нажать клавишу “e” — откроется редактор параметров загрузки ядра.

В строке с ”''linux /boot/vmlinuz-...''” еще раз убедиться, что нет параметра ''nomodeset'' и убрать ранее приписанную команду  ''systemd.unit=multi-user.target''

Ctrl+X для сохранения и выхода, и загружаемся в Debian KDE. 

iGPU работает.

===== Проверить настройки GRUB =====

[[grub2]] — пересмотреть всё, что там написано. 

В частности, не должно быть “''nomodeset''” в этой строке:

'''
GRUB_CMDLINE_LINUX_DEFAULT="quiet splash" 
'''

И не должно быть “''systemd.unit=multi-user.target''”.

И не должно быть “''acpi=strict''”.

===== Проверить iGPU =====

Утилита ''nvtop'' показала наличие двух видеокарт, ''amd'' и ''nvidia geforce''. Done!

Отныне весь GUI, звук и кино идут через процессор, а дискретная карта подключается, когда работают [[Software:Whisper]] или [[Software:DaVinci Resolve]] Но она всё ещё соединена с монитором через Display Port — если переключить на него в настройках монитора, то видео пойдёт через дискретную видеокарту. Разницу глазами не увидеть, но… 

Дальше можно заставить дискретную видеокарту принудительно «засыпать», чтобы не шуршать вентиляторами. Это больше зависит от настроек самой видеокарты, но…

1. **Отключить драйвер NVIDIA**

Если это дискретная видеокарта от nvidia

''sudo modprobe -r nvidia_drm nvidia_modeset nvidia''

Можно заблокировать драйвер через 

''systemctl disable nvidia-persistenced''

Это отключит работу видеокарты на уровне OS, но питание и вентиляторы могут остаться включены.

2. **Использовать ACPI и power management (D3cold)**

Исходим из соображения, что все современные видеокарты и их драйверы поддерживают режимы энергосбережения. Подскажем системе, что надо усыпить устройство, если оно не используется. Для полного отключения вентиляторов это должно работать, но зависит от поддержки карты и BIOS.

''echo "auto" > /sys/bus/pci/devices/0000:01:00.0/power/control или echo "auto" > .../power/runtime_status''

Сперва проверить, если есть файлы по данному адресу.
