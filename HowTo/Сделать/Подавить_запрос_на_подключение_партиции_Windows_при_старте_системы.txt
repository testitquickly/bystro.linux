Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2022-02-26T17:46:33+02:00

====== Подавить запрос на подключение партиции Windows при старте системы ======

[ @windows @policykit @fstab ]

Из Gnome в KDE может придти PolicyKit (polkit) — очень сильно интегрированный в систему сервис безопасности на уровне GUI, а не в нижних этажах близ ядра. Следит за тем, чтобы на уровне юзера явно, руками, что-то разрешалось или запрещалось на запуск. Не антивирус, но рядом.

Однако есть нюансы. У кого-то он срабатывает каждый раз, требуя пароль для запуска NetworkManager — за ним WiFi. У меня он проявился тем, что при каждом старте системы какой-то непонятный ’org.freedesktop.udisks2.filesystem-mount-system’ требует пароль для маунта ''/dev/sda2'' — на этой партиции у меня находится мастер-рекорд с Windows10, бо у меня на ноуте дуалбут.

	Вот нахера мне при запуске линукса монтировать сразу все партиции, даже если они не указаны в ''/etc/fstab'', и особенно с виндой? Если бы она была мне нужна, и я к ней обратился — тогда и спрашивай пароль…

Можно этот полисикит удалить или подавить, но будут серьёзные последствия. 

	При удалении — https://installlion.com/ubuntu/xenial/main/p/policykit-1/uninstall/index.html — он потянет за собой половину заивисимостей в системе, и останется ее только переустановить. 

	При явном подавлении начнётся частичная неработоспособность разных сервисов. 
	
	Можно прописать в настройках этой штуки разрешение делать всё, что угодно на уровне админа без запроса пароля. Внешне сработает, по-сути — откроет доступ ко всему любому кейлоггеру, который работает на уровне прав юзера, и далее по уровню упоротости вероятных взломщиков.  

Поэтому решать эту проблему надо мягко. В моём случае можно так:
* монтировать при запуске этот ''/dev/sda2'' в режиме «без права записи». Можно зайти, что-то оттуда скопировать/запустить, и только,
* прописать в настройках polkit новое правило для обработки этого монтирования. Всем юзерам из группы sudo позволено заходить на ''/dev/sda2'' сразу, безо всяких паролей. Предполагаем, что в группу sudo записаны не все юзеры, а кто записан, тому можно администрировать.

	https://www.linuxquestions.org/questions/slackware-14/change-permissions-on-partitions-to-be-accessible-without-password-4175643419/

===== Узнать UUID диска =====

''sudo blkid''

После чего будет выведен список всех разделов в системе и их UUID, вроде:

''/dev/sda2: UUID="''**''B28ED9E08ED99D63''**''" TYPE="ntfs"''

===== Отредактировать fstab =====

''sudo -e /etc/fstab''

Добавить новую строку, можно с #комментарием:

'''
# windows disk, unwanted on login
UUID=B28ED9E08ED99D63   /media/winda    ntfs defaults,ro,windows_names,noauto,noexec,ntfs=utf8 0 0
'''

Можно одной командой из-под root:

''echo "UUID=B28ED9E08ED99D63       /media/winda    ntfs defaults,ro,windows_names,noauto,noexec,ntfs=utf8 0 0" >> /etc/fstab''

После перезагрузки в ''/media/winda'' будут доступны все файлы с партиции с виндой НА ЧТЕНИЕ. И если не надо — туда можно не заходить.

Пояснение по параметрам:
* **noauto** entry in fstab is one which, for different reasons, you do not want to have mounted automatically. Иногда это сетевой диск, который может быть недоступен в момент подключения; иногда это как моя винда, не то, что нужно, но нехай буде.
* **noexec** does not allow the execution of executable binaries in the mounted file system. However, they are read, если это важно.

==== Если партиция с виндой нужна «на чтение» ====

Отредактировать fstab и в строке для винды поменять 'ro' на 'rw'

''UUID=B28ED9E08ED99D63    /media/winda    ntfs defaults,''**''rw''**'',windows_names,noauto,noexec,ntfs=utf8 0 0''

Релоад. Если всё ок, то можно остановиться.

===== Добавить новое правило в polkit =====

Возможно, этот шаг не понадобится, но если делать, то нужен рут, бо к файлам pkla даже на чтение доступ только у рута:

 ''sudo mc''

Перейти в ''/etc/polkit-1/localauthority/50-local.d/''

Сделать новый файл: 

''touch 99-mount-partitions.pkla''

Добавить в него это:

'''
[Password-less mounting of local partitions]
Identity=unix-group:sudo
Action=org.freedesktop.udisks2.filesystem-mount-system
ResultAny=yes
ResultInactive=yes
ResultActive=yes
'''

После перезагрузки этот файл исчезнет из ''/etc/polkit-1/localauthority/50-local.d/''

Но и требование выдать пароль при загрузке тоже исчезнет.

