Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2023-01-07T18:00:27+02:00

====== Samba ======

[ @network @samba @wi_fi ]

Сервер для сетевых соединений, простейший способ открыть по сети доступ к каталогу на ноутбуке.

===== Теория =====

Есть протокол обмена файлами **Server Message Block** (SMB) был придуман в IBM в восьмидесятых годах ХХ века. Он позволяет монтировать сетевые каталоги (shared folder) в Linux для прямого доступа к их содержимому из Linux и Windows в закрытой сети (безопаснее делать это через [[vsftpd]]). Под Windows такая точка доступа будет выглядеть как ''Z:\anyFolder'', в Linux как ''/mnt/anyFolder''.

Ещё есть протокол обмена файлами **Network File System** (NFS) аналогичен SMB, но пришел из мира Linux. Если к сетевому ресурсу будет нужен доступ только из Linux, рекомендуется использовать подключение по NFS, он может грамотно разрулить права на доступ к файлам/каталогам.

Ещё есть **Common Internet File System** (CIFS) — надстройка над SMB от Microsoft. 

Позже появился набор самостоятельных утилит **LinuxCIFS** — это клиент для сервера Samba, основной инструмент для монтирования SMB shares в Linux.

Итого получился протокол для обмена файлами с названием «Samba». Он же в Windows называется «Сетевое окружение». 

	* сервер **Samba**, внутри него **ksmbd** — in-kernel SMB server, выполняет задачи файлового сервера.
	* утилиты **LinuxCIFS** — это клиент для сервера Samba, основной инструмент для монтирования SMB shares в Linux.

Что любопытно — на клиентском ноуте можно использовать **LinuxCIFS** без установки Samba. И подключение к удаленным ресурсам по протоколу — smb:// — тоже работает самостоятельно.

Важно помнить, что в мире сетевых подключений всегда шарятся только каталоги, а не диски целиком.

===== Установить =====

[[Debian:Install:Samba]]

===== Создать shared folder =====

Допустим, надо расшарить каталог /home/hdd/Images с гостевым доступом.

==== Из ''Dolphin'' или ''Krusader'' ====

''Dolphin'' 
''> правой кнопкой по каталогу «для расшары»''
''> Свойства''
''> Публикация''

«Открыть общий доступ к этой папке для компьютеров локальной сети». Тут же можно выбрать другое название для этого shared folder — это название будет «видно» с других компьютеров.

«Разрешить гостевой доступ» — для гостевого доступа (просмотр фильмов) установить «Everyone = Только чтение».

ОК

Можно тут же в Dolphin открыть адрес 

''smb://''

там будут все shared folders с ноутбука.

==== Из консоли ====

=== Настроить права каталога ===

Перепроверить, что этот каталог принадлежит действующему пользователю и у него есть доступ на запись в этот каталог:

''ls -ld /home/hdd/Images''

''sudo chown -R astenix:sambashare /home/hdd/Images''

''sudo chmod -R 2770 /home/hdd/Images''

Тут ''2 (setgid)'' делает так, что все новые файлы наследуют группу ''sambashare''.

=== Добавить информацию о новой шаре в систему ===

sudo mcedit /etc/samba/smb.conf

В конце файла записать:

''[Images]''
''path = /home/hdd/Images''
''comment = Public images''
''public = yes''
''browseable = yes''
''writable = yes''
''read only = no''
''guest ok = yes''
''create mask = 0660''
''directory mask = 0770''
''valid users = astenix''
''force group = sambashare''

Если надо открыть каталог только на чтение:    ''read only = yes''

Перезапустить Samba:

''sudo systemctl restart smbd''

==== Проверить открытые шары ====

''net usershare list''

В ответе будут названия расшаренным каталогов.

То же самое можно посмотреть в каталоге

'''
cd /var/lib/samba/usershares
'''

Каждый файл в этом каталоге — конфиг шары, которую создал юзер.

===== Настроить доступ к Shared folder по паролю =====

''sudo smbpasswd -a astenix''

Записать пароль, чтобы не потерялся.

Добавить в систему новый shared folder:

''sudo mcedit /etc/samba/smb.conf''

Внизу добавить новые строки:

''[Images]''
''path = /home/hdd/Images''
''comment = public images''
''public = yes''
''browseable = yes''
''writable = yes''
''read only = no''
''guest ok = no''
''create mask = 0777''
''directory mask = 0777''
''force create mode = 0777''
''force directory mode = 0777''
''valid users = astenix''
''force group = sambashare''

===== Подключиться к shared folder =====

Сперва надо знать IP ноута, к которому надо подключиться, например

''192.168.50.18''

И оба ноута должны быть в одной сети.

==== Из Linux ====

В системе должен быть установлен пакет ''cifs-utils''.

Сделать каталог, в который будет сделан mount:

''sudo mkdir -p /mnt/Images''

Примонтировать удаленный каталог:

''mount -t cifs "//192.168.50.18/Images" /mnt/Images -o user=astenix''
 
Если надо всегда подключать этот каталог при запуске ноута:

''sudo mcedit /etc/fstab''

и добавить туда

''//192.168.50.18/Images  /mnt/Images  cifs  username=astenix,password=''__''XXXX''__'',vers=3.0  0  0''

Если надо просто подключиться к сетевому ресурсу, без монтирования, то можно ввести команду:

''smbclient -U astenix 192.168.50.18\Images''

Или открыть Dolphin или Krusader и пройти по адресу 

''smb://192.168.50.18''

==== Из Windows ====

Через проводник, зайдя в Компьютер -> Подключить сетевой диск

Либо с помощью коммандной строки: 

''net use N: \\192.168.1.1\private /persistent:yes''

Тут:

	N: — имя сетевого диска;
	\\192.168.1.1\private — путь до сетевого каталога;
	persistent:yes — указывает на то, что нужно восстанавливать данный диск каждый раз при входе в систему.
