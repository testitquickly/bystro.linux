Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.6
Creation-Date: 2025-10-25T04:30:16+03:00

====== Добавить звуковую волну в mpv ======

[ @sound @mpv ]

Иногда проще и быстрее открывать аудиофайлы через видеоплеер mpv. Хочется при этом видеть в окне плеера звуковую волну.

В норме для этого аудиофайл обрабатывают через ffmpeg, после чего на диске появляется новый файл mp4 с волноформой в качестве видеоряда. Это занимает какое-то время и в принципе, не нужно.
 
Можно заставить ffmpeg делать обработку аудиофайла «на лету», словно речь идет о стриминге. Недостаток этого подхода — стриминг же, содержимое файла в плеере появляется постепенно, и невозможно прокручивать ползунок проигрывателя //вперед// больше чем на десяток секунд; и если файл «долгоиграющий», то через какое-то время начинают выть кулеры. В этом случае смотреть [[Software:Audacity]]

Сделать скрипт ''mpv_audio_wave.sh'':

{{{code: lang="sh" linenumbers="True"
#!/bin/bash

    # Открываю аудиофайлы через видеоплеер mpv и надо, чтобы в окне прыгала волна аудио
    # Для этого поток сперва надо обработать через ffmpeg, но это занимает какое-то время,
    # и этот скрипт заставляет ffmpeg делать обработку аудиофайла «на лету»

if [ -z "$1" ]; then
    echo "Использование: aud <имя_файла>"
    exit 1
fi

# снимаем экранирование пробелов, если mc передал имя файла с обратными слешами
file=$(echo "$1" | sed 's/\\ / /g')

    # ускоряем поток ffmpeg, отключаем лишние сообщения
    # окна и волна появятся мгновенно,
    # предупреждения почти не будут мешать,
    # прерывание q или Ctrl+C не будет оставлять кучу ошибок в терминале.
    
    # -hide_banner -loglevel error — ffmpeg больше не выводит лишнюю информацию.
    # -stats — оставляем только прогресс (можно убрать, если не нужен).
    # --really-quiet — mpv не пишет предупреждения.
    # --ao=pulse — явно используем PulseAudio вместо PipeWire.
    # --vo=x11 — надежное ускоренное отображение видео.Если есть gpu, можно указать --vo=gpu

ffmpeg -hide_banner -loglevel error -stats -i "$file" \
  -filter_complex "aformat=channel_layouts=stereo,showwaves=s=1280x720:mode=line:colors=gold" \
  -pix_fmt yuv420p -f matroska - | \
mpv - --force-window=yes --vo=x11 --really-quiet --ao=pulse

}}}

В [[Software:Midnight Commander]] добавить в User menu команду для запуска аудиофайлов через этот скрипт:

''F9''
''> Команда''
''> Редактировать файл меню (пользовательский)''

Добавить две новые строки:

''Открыть аудио через mpv_audio_wave.sh''
	''sh -c '~/mpv_audio_wave.sh "%f"'''

Сохранить, выйти.

Перейти в каталог с аудиофайлами. 

''F2'' 
''> “Открыть аудио через mpv_audio_wave.sh”''

Если открыть через этот скрипт видеофайл — на экране будет только звук и его волновая форма.
